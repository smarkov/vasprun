"""Test vasprun.xml reader"""
import unittest
import numpy as np
import numpy.testing as nptest
from pprint import pprint
from vasprun.io import parse_vasprun

def read_vasp_eigenval(file):
    """Read EIGENVAL file from VASP and return bands"""
    with open(file, 'r') as fp:
        for i in range(5):
            _ = fp.readline()
        _, nkpts, nbands = [int(x) for x in fp.readline().split()]
        _ = fp.readline()
        band_energies = [[] for i in range(nbands)]
        for ik in range(nkpts):
            kx, ky, kz, weight = [float(word) for word in fp.readline().split()]
            for jband in range(nbands):
                words = fp.readline().split()
                jband, eigenval = int(words[0]), float(words[1])
                band_energies[jband - 1].append(eigenval)
            _ = fp.readline()
    return band_energies


class XMLReadTest(unittest.TestCase):
    """
    Test XML reader
    """
    def test_unpolarised_scf(self):
        """Can we read xml from unpolarised SCF calculation with k-mesh"""
        refkptstr = """
            <v>       0.00000000       0.00000000       0.00000000 </v>
            <v>       0.04761905       0.00000000       0.00000000 </v>
            <v>       0.09523810       0.00000000       0.00000000 </v>
            <v>       0.14285714       0.00000000       0.00000000 </v>
            <v>       0.19047619       0.00000000       0.00000000 </v>
            <v>       0.23809524       0.00000000       0.00000000 </v>
            <v>       0.28571429       0.00000000       0.00000000 </v>
            <v>       0.33333333       0.00000000       0.00000000 </v>
            <v>       0.38095238       0.00000000       0.00000000 </v>
            <v>       0.42857143       0.00000000       0.00000000 </v>
            <v>       0.47619048       0.00000000       0.00000000 </v>
            <v>       0.04761905       0.04761905       0.00000000 </v>
            <v>       0.09523810       0.04761905       0.00000000 </v>
            <v>       0.14285714       0.04761905       0.00000000 </v>
            <v>       0.19047619       0.04761905       0.00000000 </v>
            <v>       0.23809524       0.04761905       0.00000000 </v>
            <v>       0.28571429       0.04761905       0.00000000 </v>
            <v>       0.33333333       0.04761905       0.00000000 </v>
            <v>       0.38095238       0.04761905       0.00000000 </v>
            <v>       0.42857143       0.04761905       0.00000000 </v>
            <v>       0.47619048       0.04761905       0.00000000 </v>
            <v>      -0.47619048       0.04761905       0.00000000 </v>
            <v>      -0.42857143       0.04761905       0.00000000 </v>
            <v>      -0.38095238       0.04761905       0.00000000 </v>
            <v>      -0.33333333       0.04761905       0.00000000 </v>
            <v>      -0.28571429       0.04761905       0.00000000 </v>
            <v>      -0.23809524       0.04761905       0.00000000 </v>
            <v>      -0.19047619       0.04761905       0.00000000 </v>
            <v>      -0.14285714       0.04761905       0.00000000 </v>
            <v>      -0.09523810       0.04761905       0.00000000 </v>
            <v>      -0.04761905       0.04761905       0.00000000 </v>
            <v>       0.09523810       0.09523810       0.00000000 </v>
            <v>       0.14285714       0.09523810       0.00000000 </v>
            <v>       0.19047619       0.09523810       0.00000000 </v>
            <v>       0.23809524       0.09523810       0.00000000 </v>
            <v>       0.28571429       0.09523810       0.00000000 </v>
            <v>       0.33333333       0.09523810       0.00000000 </v>
            <v>       0.38095238       0.09523810       0.00000000 </v>
            <v>       0.42857143       0.09523810       0.00000000 </v>
            <v>       0.47619048       0.09523810       0.00000000 </v>
            <v>      -0.47619048       0.09523810       0.00000000 </v>
            <v>      -0.42857143       0.09523810       0.00000000 </v>
            <v>      -0.38095238       0.09523810       0.00000000 </v>
            <v>      -0.33333333       0.09523810       0.00000000 </v>
            <v>      -0.28571429       0.09523810       0.00000000 </v>
            <v>      -0.23809524       0.09523810       0.00000000 </v>
            <v>      -0.19047619       0.09523810       0.00000000 </v>
            <v>      -0.14285714       0.09523810       0.00000000 </v>
            <v>      -0.09523810       0.09523810       0.00000000 </v>
            <v>       0.14285714       0.14285714       0.00000000 </v>
            <v>       0.19047619       0.14285714       0.00000000 </v>
            <v>       0.23809524       0.14285714       0.00000000 </v>
            <v>       0.28571429       0.14285714       0.00000000 </v>
            <v>       0.33333333       0.14285714       0.00000000 </v>
            <v>       0.38095238       0.14285714       0.00000000 </v>
            <v>       0.42857143       0.14285714       0.00000000 </v>
            <v>       0.47619048       0.14285714       0.00000000 </v>
            <v>      -0.47619048       0.14285714       0.00000000 </v>
            <v>      -0.42857143       0.14285714       0.00000000 </v>
            <v>      -0.38095238       0.14285714       0.00000000 </v>
            <v>      -0.33333333       0.14285714       0.00000000 </v>
            <v>      -0.28571429       0.14285714       0.00000000 </v>
            <v>      -0.23809524       0.14285714       0.00000000 </v>
            <v>      -0.19047619       0.14285714       0.00000000 </v>
            <v>      -0.14285714       0.14285714       0.00000000 </v>
            <v>       0.19047619       0.19047619       0.00000000 </v>
            <v>       0.23809524       0.19047619       0.00000000 </v>
            <v>       0.28571429       0.19047619       0.00000000 </v>
            <v>       0.33333333       0.19047619       0.00000000 </v>
            <v>       0.38095238       0.19047619       0.00000000 </v>
            <v>       0.42857143       0.19047619       0.00000000 </v>
            <v>       0.47619048       0.19047619       0.00000000 </v>
            <v>      -0.47619048       0.19047619       0.00000000 </v>
            <v>      -0.42857143       0.19047619       0.00000000 </v>
            <v>      -0.38095238       0.19047619       0.00000000 </v>
            <v>      -0.33333333       0.19047619       0.00000000 </v>
            <v>      -0.28571429       0.19047619       0.00000000 </v>
            <v>      -0.23809524       0.19047619       0.00000000 </v>
            <v>      -0.19047619       0.19047619       0.00000000 </v>
            <v>       0.23809524       0.23809524       0.00000000 </v>
            <v>       0.28571429       0.23809524       0.00000000 </v>
            <v>       0.33333333       0.23809524       0.00000000 </v>
            <v>       0.38095238       0.23809524       0.00000000 </v>
            <v>       0.42857143       0.23809524       0.00000000 </v>
            <v>       0.47619048       0.23809524       0.00000000 </v>
            <v>      -0.47619048       0.23809524       0.00000000 </v>
            <v>      -0.42857143       0.23809524       0.00000000 </v>
            <v>      -0.38095238       0.23809524       0.00000000 </v>
            <v>      -0.33333333       0.23809524       0.00000000 </v>
            <v>      -0.28571429       0.23809524       0.00000000 </v>
            <v>      -0.23809524       0.23809524       0.00000000 </v>
            <v>       0.28571429       0.28571429       0.00000000 </v>
            <v>       0.33333333       0.28571429       0.00000000 </v>
            <v>       0.38095238       0.28571429       0.00000000 </v>
            <v>       0.42857143       0.28571429       0.00000000 </v>
            <v>       0.47619048       0.28571429       0.00000000 </v>
            <v>      -0.47619048       0.28571429       0.00000000 </v>
            <v>      -0.42857143       0.28571429       0.00000000 </v>
            <v>      -0.38095238       0.28571429       0.00000000 </v>
            <v>      -0.33333333       0.28571429       0.00000000 </v>
            <v>      -0.28571429       0.28571429       0.00000000 </v>
            <v>       0.33333333       0.33333333       0.00000000 </v>
            <v>       0.38095238       0.33333333       0.00000000 </v>
            <v>       0.42857143       0.33333333       0.00000000 </v>
            <v>       0.47619048       0.33333333       0.00000000 </v>
            <v>      -0.47619048       0.33333333       0.00000000 </v>
            <v>      -0.42857143       0.33333333       0.00000000 </v>
            <v>      -0.38095238       0.33333333       0.00000000 </v>
            <v>      -0.33333333       0.33333333       0.00000000 </v>
            <v>       0.38095238       0.38095238       0.00000000 </v>
            <v>       0.42857143       0.38095238       0.00000000 </v>
            <v>       0.47619048       0.38095238       0.00000000 </v>
            <v>      -0.47619048       0.38095238       0.00000000 </v>
            <v>      -0.42857143       0.38095238       0.00000000 </v>
            <v>      -0.38095238       0.38095238       0.00000000 </v>
            <v>       0.42857143       0.42857143       0.00000000 </v>
            <v>       0.47619048       0.42857143       0.00000000 </v>
            <v>      -0.47619048       0.42857143       0.00000000 </v>
            <v>      -0.42857143       0.42857143       0.00000000 </v>
            <v>       0.47619048       0.47619048       0.00000000 </v>
            <v>      -0.47619048       0.47619048       0.00000000 </v>
            <v>       0.14285714       0.09523810       0.04761905 </v>
            <v>       0.19047619       0.09523810       0.04761905 </v>
            <v>       0.23809524       0.09523810       0.04761905 </v>
            <v>       0.28571429       0.09523810       0.04761905 </v>
            <v>       0.33333333       0.09523810       0.04761905 </v>
            <v>       0.38095238       0.09523810       0.04761905 </v>
            <v>       0.42857143       0.09523810       0.04761905 </v>
            <v>       0.47619048       0.09523810       0.04761905 </v>
            <v>      -0.47619048       0.09523810       0.04761905 </v>
            <v>       0.19047619       0.14285714       0.04761905 </v>
            <v>       0.23809524       0.14285714       0.04761905 </v>
            <v>       0.28571429       0.14285714       0.04761905 </v>
            <v>       0.33333333       0.14285714       0.04761905 </v>
            <v>       0.38095238       0.14285714       0.04761905 </v>
            <v>       0.42857143       0.14285714       0.04761905 </v>
            <v>       0.47619048       0.14285714       0.04761905 </v>
            <v>      -0.47619048       0.14285714       0.04761905 </v>
            <v>      -0.42857143       0.14285714       0.04761905 </v>
            <v>      -0.38095238       0.14285714       0.04761905 </v>
            <v>      -0.33333333       0.14285714       0.04761905 </v>
            <v>      -0.28571429       0.14285714       0.04761905 </v>
            <v>      -0.23809524       0.14285714       0.04761905 </v>
            <v>      -0.19047619       0.14285714       0.04761905 </v>
            <v>      -0.14285714       0.14285714       0.04761905 </v>
            <v>      -0.09523810       0.14285714       0.04761905 </v>
            <v>       0.23809524       0.19047619       0.04761905 </v>
            <v>       0.28571429       0.19047619       0.04761905 </v>
            <v>       0.33333333       0.19047619       0.04761905 </v>
            <v>       0.38095238       0.19047619       0.04761905 </v>
            <v>       0.42857143       0.19047619       0.04761905 </v>
            <v>       0.47619048       0.19047619       0.04761905 </v>
            <v>      -0.47619048       0.19047619       0.04761905 </v>
            <v>      -0.42857143       0.19047619       0.04761905 </v>
            <v>      -0.38095238       0.19047619       0.04761905 </v>
            <v>      -0.33333333       0.19047619       0.04761905 </v>
            <v>      -0.28571429       0.19047619       0.04761905 </v>
            <v>      -0.23809524       0.19047619       0.04761905 </v>
            <v>      -0.19047619       0.19047619       0.04761905 </v>
            <v>      -0.14285714       0.19047619       0.04761905 </v>
            <v>       0.28571429       0.23809524       0.04761905 </v>
            <v>       0.33333333       0.23809524       0.04761905 </v>
            <v>       0.38095238       0.23809524       0.04761905 </v>
            <v>       0.42857143       0.23809524       0.04761905 </v>
            <v>       0.47619048       0.23809524       0.04761905 </v>
            <v>      -0.47619048       0.23809524       0.04761905 </v>
            <v>      -0.42857143       0.23809524       0.04761905 </v>
            <v>      -0.38095238       0.23809524       0.04761905 </v>
            <v>      -0.33333333       0.23809524       0.04761905 </v>
            <v>      -0.28571429       0.23809524       0.04761905 </v>
            <v>      -0.23809524       0.23809524       0.04761905 </v>
            <v>      -0.19047619       0.23809524       0.04761905 </v>
            <v>       0.33333333       0.28571429       0.04761905 </v>
            <v>       0.38095238       0.28571429       0.04761905 </v>
            <v>       0.42857143       0.28571429       0.04761905 </v>
            <v>       0.47619048       0.28571429       0.04761905 </v>
            <v>      -0.47619048       0.28571429       0.04761905 </v>
            <v>      -0.42857143       0.28571429       0.04761905 </v>
            <v>      -0.38095238       0.28571429       0.04761905 </v>
            <v>      -0.33333333       0.28571429       0.04761905 </v>
            <v>      -0.28571429       0.28571429       0.04761905 </v>
            <v>      -0.23809524       0.28571429       0.04761905 </v>
            <v>       0.38095238       0.33333333       0.04761905 </v>
            <v>       0.42857143       0.33333333       0.04761905 </v>
            <v>       0.47619048       0.33333333       0.04761905 </v>
            <v>      -0.47619048       0.33333333       0.04761905 </v>
            <v>      -0.42857143       0.33333333       0.04761905 </v>
            <v>      -0.38095238       0.33333333       0.04761905 </v>
            <v>      -0.33333333       0.33333333       0.04761905 </v>
            <v>      -0.28571429       0.33333333       0.04761905 </v>
            <v>       0.42857143       0.38095238       0.04761905 </v>
            <v>       0.47619048       0.38095238       0.04761905 </v>
            <v>      -0.47619048       0.38095238       0.04761905 </v>
            <v>      -0.42857143       0.38095238       0.04761905 </v>
            <v>      -0.38095238       0.38095238       0.04761905 </v>
            <v>      -0.33333333       0.38095238       0.04761905 </v>
            <v>       0.47619048       0.42857143       0.04761905 </v>
            <v>      -0.47619048       0.42857143       0.04761905 </v>
            <v>      -0.42857143       0.42857143       0.04761905 </v>
            <v>      -0.38095238       0.42857143       0.04761905 </v>
            <v>      -0.47619048       0.47619048       0.04761905 </v>
            <v>      -0.42857143       0.47619048       0.04761905 </v>
            <v>       0.28571429       0.19047619       0.09523810 </v>
            <v>       0.33333333       0.19047619       0.09523810 </v>
            <v>       0.38095238       0.19047619       0.09523810 </v>
            <v>       0.42857143       0.19047619       0.09523810 </v>
            <v>       0.47619048       0.19047619       0.09523810 </v>
            <v>      -0.47619048       0.19047619       0.09523810 </v>
            <v>      -0.42857143       0.19047619       0.09523810 </v>
            <v>       0.33333333       0.23809524       0.09523810 </v>
            <v>       0.38095238       0.23809524       0.09523810 </v>
            <v>       0.42857143       0.23809524       0.09523810 </v>
            <v>       0.47619048       0.23809524       0.09523810 </v>
            <v>      -0.47619048       0.23809524       0.09523810 </v>
            <v>      -0.42857143       0.23809524       0.09523810 </v>
            <v>      -0.38095238       0.23809524       0.09523810 </v>
            <v>      -0.33333333       0.23809524       0.09523810 </v>
            <v>      -0.28571429       0.23809524       0.09523810 </v>
            <v>      -0.23809524       0.23809524       0.09523810 </v>
            <v>      -0.19047619       0.23809524       0.09523810 </v>
            <v>      -0.14285714       0.23809524       0.09523810 </v>
            <v>       0.38095238       0.28571429       0.09523810 </v>
            <v>       0.42857143       0.28571429       0.09523810 </v>
            <v>       0.47619048       0.28571429       0.09523810 </v>
            <v>      -0.47619048       0.28571429       0.09523810 </v>
            <v>      -0.42857143       0.28571429       0.09523810 </v>
            <v>      -0.38095238       0.28571429       0.09523810 </v>
            <v>      -0.33333333       0.28571429       0.09523810 </v>
            <v>      -0.28571429       0.28571429       0.09523810 </v>
            <v>      -0.23809524       0.28571429       0.09523810 </v>
            <v>      -0.19047619       0.28571429       0.09523810 </v>
            <v>       0.42857143       0.33333333       0.09523810 </v>
            <v>       0.47619048       0.33333333       0.09523810 </v>
            <v>      -0.47619048       0.33333333       0.09523810 </v>
            <v>      -0.42857143       0.33333333       0.09523810 </v>
            <v>      -0.38095238       0.33333333       0.09523810 </v>
            <v>      -0.33333333       0.33333333       0.09523810 </v>
            <v>      -0.28571429       0.33333333       0.09523810 </v>
            <v>      -0.23809524       0.33333333       0.09523810 </v>
            <v>       0.47619048       0.38095238       0.09523810 </v>
            <v>      -0.47619048       0.38095238       0.09523810 </v>
            <v>      -0.42857143       0.38095238       0.09523810 </v>
            <v>      -0.38095238       0.38095238       0.09523810 </v>
            <v>      -0.33333333       0.38095238       0.09523810 </v>
            <v>      -0.28571429       0.38095238       0.09523810 </v>
            <v>      -0.47619048       0.42857143       0.09523810 </v>
            <v>      -0.42857143       0.42857143       0.09523810 </v>
            <v>      -0.38095238       0.42857143       0.09523810 </v>
            <v>      -0.33333333       0.42857143       0.09523810 </v>
            <v>      -0.42857143       0.47619048       0.09523810 </v>
            <v>      -0.38095238       0.47619048       0.09523810 </v>
            <v>       0.42857143       0.28571429       0.14285714 </v>
            <v>       0.47619048       0.28571429       0.14285714 </v>
            <v>      -0.47619048       0.28571429       0.14285714 </v>
            <v>      -0.42857143       0.28571429       0.14285714 </v>
            <v>      -0.38095238       0.28571429       0.14285714 </v>
            <v>       0.47619048       0.33333333       0.14285714 </v>
            <v>      -0.47619048       0.33333333       0.14285714 </v>
            <v>      -0.42857143       0.33333333       0.14285714 </v>
            <v>      -0.38095238       0.33333333       0.14285714 </v>
            <v>      -0.33333333       0.33333333       0.14285714 </v>
            <v>      -0.28571429       0.33333333       0.14285714 </v>
            <v>      -0.23809524       0.33333333       0.14285714 </v>
            <v>      -0.19047619       0.33333333       0.14285714 </v>
            <v>      -0.47619048       0.38095238       0.14285714 </v>
            <v>      -0.42857143       0.38095238       0.14285714 </v>
            <v>      -0.38095238       0.38095238       0.14285714 </v>
            <v>      -0.33333333       0.38095238       0.14285714 </v>
            <v>      -0.28571429       0.38095238       0.14285714 </v>
            <v>      -0.23809524       0.38095238       0.14285714 </v>
            <v>      -0.42857143       0.42857143       0.14285714 </v>
            <v>      -0.38095238       0.42857143       0.14285714 </v>
            <v>      -0.33333333       0.42857143       0.14285714 </v>
            <v>      -0.28571429       0.42857143       0.14285714 </v>
            <v>      -0.38095238       0.47619048       0.14285714 </v>
            <v>      -0.33333333       0.47619048       0.14285714 </v>
            <v>      -0.42857143       0.38095238       0.19047619 </v>
            <v>      -0.38095238       0.38095238       0.19047619 </v>
            <v>      -0.33333333       0.38095238       0.19047619 </v>
            <v>      -0.38095238       0.42857143       0.19047619 </v>
            <v>      -0.33333333       0.42857143       0.19047619 </v>
            <v>      -0.28571429       0.42857143       0.19047619 </v>
            <v>      -0.23809524       0.42857143       0.19047619 </v>
            <v>      -0.33333333       0.47619048       0.19047619 </v>
            <v>      -0.28571429       0.47619048       0.19047619 </v>
            <v>      -0.28571429       0.47619048       0.23809524 </v>
        """
        # note that in the string above, the data lines start with '\n'
        # due to using the opening """ on its own line
        refkptstr = refkptstr.replace('\n', '')
        refkptstr = refkptstr.replace('<v>', '')
        refkptstr = refkptstr.replace('</v>', '\n')
        # the [:-1] necessary due to the last '\n' followed by the 
        # spaces that precede the closing """
        refkpts = [np.fromstring(line, sep=' ')
                   for line in refkptstr.split('\n')[:-1]]
        ref_data = {
            'SYSTEM': 'Si0.5Ge0.5 zincblende primitive PBESol',
            'ENMAX': 320.0,
            'ENAUG': 640.0,
            'EDIFF': 0.1e-4,
            'NELECT': 8.0,
            'EREF': 0.0,
#            'ISMEAR': 0,
#            'ICHARG': 2,
#            'SIGMA': 0.1,
            'NBANDS': 24,

            'ISPIN': 1,
            'LSORBIT': False,
            'LNONCOLLINEAR': False,
            'SAXIS': [0, 0, 1.],
            'MAGMOM': [1., 1.],

#            'NSW': 0,
            'IBRION': -1,
            'ISIF': 2,
            'EDIFFG': 0.1e-3,
            'GGA': 'PS',

            'efermi': 5.06299199,
            'e_fr_energy': -10.57676490,
            'e_wo_entrp': -10.57676434,
            'e_0_energy': -0.00000112,

            'kmesh_type': 'Monkhorst-Pack',
            'kmesh_division': [21, 21, 21],
            'kpoints': refkpts,
        }
        data = parse_vasprun('ref/unpolarised/scf/vasprun.xml')
        for key, val in ref_data.items():
            try:
                self.assertEqual(val, data[key])
            except ValueError:
                self.assertEqual(np.asarray(val).shape, data[key].shape)
                nptest.assert_array_equal(np.asarray(val), data[key])

    def test_unpolarised_bands_explicitkpts(self):
        """Can we read xml from bands calculation with explicit k-points"""
        refkptstr = """
            <v>       0.50000000       0.50000000       0.50000000 </v>
            <v>       0.47619000       0.47619000       0.47619000 </v>
            <v>       0.45238100       0.45238100       0.45238100 </v>
            <v>       0.42857100       0.42857100       0.42857100 </v>
            <v>       0.40476200       0.40476200       0.40476200 </v>
            <v>       0.38095200       0.38095200       0.38095200 </v>
            <v>       0.35714300       0.35714300       0.35714300 </v>
            <v>       0.33333300       0.33333300       0.33333300 </v>
            <v>       0.30952400       0.30952400       0.30952400 </v>
            <v>       0.28571400       0.28571400       0.28571400 </v>
            <v>       0.26190500       0.26190500       0.26190500 </v>
            <v>       0.23809500       0.23809500       0.23809500 </v>
            <v>       0.21428600       0.21428600       0.21428600 </v>
            <v>       0.19047600       0.19047600       0.19047600 </v>
            <v>       0.16666700       0.16666700       0.16666700 </v>
            <v>       0.14285700       0.14285700       0.14285700 </v>
            <v>       0.11904800       0.11904800       0.11904800 </v>
            <v>       0.09523800       0.09523800       0.09523800 </v>
            <v>       0.07142900       0.07142900       0.07142900 </v>
            <v>       0.04761900       0.04761900       0.04761900 </v>
            <v>       0.02381000       0.02381000       0.02381000 </v>
            <v>       0.00000000       0.00000000       0.00000000 </v>
            <v>       0.02083300       0.00000000       0.02083300 </v>
            <v>       0.04166700       0.00000000       0.04166700 </v>
            <v>       0.06250000       0.00000000       0.06250000 </v>
            <v>       0.08333300       0.00000000       0.08333300 </v>
            <v>       0.10416700       0.00000000       0.10416700 </v>
            <v>       0.12500000       0.00000000       0.12500000 </v>
            <v>       0.14583300       0.00000000       0.14583300 </v>
            <v>       0.16666700       0.00000000       0.16666700 </v>
            <v>       0.18750000       0.00000000       0.18750000 </v>
            <v>       0.20833300       0.00000000       0.20833300 </v>
            <v>       0.22916700       0.00000000       0.22916700 </v>
            <v>       0.25000000       0.00000000       0.25000000 </v>
            <v>       0.27083300       0.00000000       0.27083300 </v>
            <v>       0.29166700       0.00000000       0.29166700 </v>
            <v>       0.31250000       0.00000000       0.31250000 </v>
            <v>       0.33333300       0.00000000       0.33333300 </v>
            <v>       0.35416700       0.00000000       0.35416700 </v>
            <v>       0.37500000       0.00000000       0.37500000 </v>
            <v>       0.39583300       0.00000000       0.39583300 </v>
            <v>       0.41666700       0.00000000       0.41666700 </v>
            <v>       0.43750000       0.00000000       0.43750000 </v>
            <v>       0.45833300       0.00000000       0.45833300 </v>
            <v>       0.47916700       0.00000000       0.47916700 </v>
            <v>       0.50000000       0.00000000       0.50000000 </v>
            <v>       0.51562500       0.03125000       0.51562500 </v>
            <v>       0.53125000       0.06250000       0.53125000 </v>
            <v>       0.54687500       0.09375000       0.54687500 </v>
            <v>       0.56250000       0.12500000       0.56250000 </v>
            <v>       0.57812500       0.15625000       0.57812500 </v>
            <v>       0.59375000       0.18750000       0.59375000 </v>
            <v>       0.60937500       0.21875000       0.60937500 </v>
            <v>       0.62500000       0.25000000       0.62500000 </v>
            <v>       0.37500000       0.37500000       0.75000000 </v>
            <v>       0.36111100       0.36111100       0.72222200 </v>
            <v>       0.34722200       0.34722200       0.69444400 </v>
            <v>       0.33333300       0.33333300       0.66666700 </v>
            <v>       0.31944400       0.31944400       0.63888900 </v>
            <v>       0.30555600       0.30555600       0.61111100 </v>
            <v>       0.29166700       0.29166700       0.58333300 </v>
            <v>       0.27777800       0.27777800       0.55555600 </v>
            <v>       0.26388900       0.26388900       0.52777800 </v>
            <v>       0.25000000       0.25000000       0.50000000 </v>
            <v>       0.23611100       0.23611100       0.47222200 </v>
            <v>       0.22222200       0.22222200       0.44444400 </v>
            <v>       0.20833300       0.20833300       0.41666700 </v>
            <v>       0.19444400       0.19444400       0.38888900 </v>
            <v>       0.18055600       0.18055600       0.36111100 </v>
            <v>       0.16666700       0.16666700       0.33333300 </v>
            <v>       0.15277800       0.15277800       0.30555600 </v>
            <v>       0.13888900       0.13888900       0.27777800 </v>
            <v>       0.12500000       0.12500000       0.25000000 </v>
            <v>       0.11111100       0.11111100       0.22222200 </v>
            <v>       0.09722200       0.09722200       0.19444400 </v>
            <v>       0.08333300       0.08333300       0.16666700 </v>
            <v>       0.06944400       0.06944400       0.13888900 </v>
            <v>       0.05555600       0.05555600       0.11111100 </v>
            <v>       0.04166700       0.04166700       0.08333300 </v>
            <v>       0.02777800       0.02777800       0.05555600 </v>
            <v>       0.01388900       0.01388900       0.02777800 </v>
            <v>       0.00000000       0.00000000       0.00000000 </v>
        """
        # note that in the string above, the data lines start with '\n'
        # due to using the opening """ on its own line
        refkptstr = refkptstr.replace('\n', '')
        refkptstr = refkptstr.replace('<v>', '')
        refkptstr = refkptstr.replace('</v>', '\n')
        # the [:-1] necessary due to the last '\n' followed by the 
        # spaces that precede the closing """
        refkpts = [np.fromstring(line, sep=' ')
                   for line in refkptstr.split('\n')[:-1]]
        refeigenvals = read_vasp_eigenval('ref/unpolarised/bands-explicitkpts/EIGENVAL')
        ref_data = {
            'SYSTEM': 'Si0.5Ge0.5 zincblende primitive PBESol',
            'ENMAX': 320.0,
            'ENAUG': 640.0,
            'EDIFF': 0.1e-4,
            'NELECT': 8.0,
            'EREF': 0.0,
#            'ISMEAR': 0,
#            'ICHARG': 2,
#            'SIGMA': 0.1,
            'NBANDS': 24,

            'ISPIN': 1,
            'LSORBIT': False,
            'LNONCOLLINEAR': False,
            'SAXIS': [0, 0, 1.],
            'MAGMOM': [1., 1.],

#            'NSW': 0,
            'IBRION': -1,
            'ISIF': 2,
            'EDIFFG': 0.1e-3,
            'GGA': 'PS',

            'efermi': 5.07886319,
            'e_fr_energy': -5.06115143,
            'e_wo_entrp': -5.06110238,
            'e_0_energy': -0.00009809,

            'kmesh_type': None,
            'kmesh_division': None,
            'kpoints': refkpts,

            'eigenvalues': refeigenvals,
        }
        data = parse_vasprun('ref/unpolarised/bands-explicitkpts/vasprun.xml')
        for key, val in ref_data.items():
            try:
                self.assertEqual(val, data[key])
            except ValueError:
                self.assertEqual(np.asarray(val).shape, data[key].shape)
                nptest.assert_array_almost_equal(np.asarray(val), data[key], decimal=4)

    def test_unpolarised_bands_autokpts(self):
        """Can we read xml from bands calculation with auto-generated k-points"""
        refkptstr = """
            <v>       0.00000000       0.00000000       0.00000000 </v>
            <v>       0.01282051       0.00000000       0.01282051 </v>
            <v>       0.02564103       0.00000000       0.02564103 </v>
            <v>       0.03846154       0.00000000       0.03846154 </v>
            <v>       0.05128205       0.00000000       0.05128205 </v>
            <v>       0.06410256       0.00000000       0.06410256 </v>
            <v>       0.07692308       0.00000000       0.07692308 </v>
            <v>       0.08974359       0.00000000       0.08974359 </v>
            <v>       0.10256410       0.00000000       0.10256410 </v>
            <v>       0.11538462       0.00000000       0.11538462 </v>
            <v>       0.12820513       0.00000000       0.12820513 </v>
            <v>       0.14102564       0.00000000       0.14102564 </v>
            <v>       0.15384615       0.00000000       0.15384615 </v>
            <v>       0.16666667       0.00000000       0.16666667 </v>
            <v>       0.17948718       0.00000000       0.17948718 </v>
            <v>       0.19230769       0.00000000       0.19230769 </v>
            <v>       0.20512821       0.00000000       0.20512821 </v>
            <v>       0.21794872       0.00000000       0.21794872 </v>
            <v>       0.23076923       0.00000000       0.23076923 </v>
            <v>       0.24358974       0.00000000       0.24358974 </v>
            <v>       0.25641026       0.00000000       0.25641026 </v>
            <v>       0.26923077       0.00000000       0.26923077 </v>
            <v>       0.28205128       0.00000000       0.28205128 </v>
            <v>       0.29487179       0.00000000       0.29487179 </v>
            <v>       0.30769231       0.00000000       0.30769231 </v>
            <v>       0.32051282       0.00000000       0.32051282 </v>
            <v>       0.33333333       0.00000000       0.33333333 </v>
            <v>       0.34615385       0.00000000       0.34615385 </v>
            <v>       0.35897436       0.00000000       0.35897436 </v>
            <v>       0.37179487       0.00000000       0.37179487 </v>
            <v>       0.38461538       0.00000000       0.38461538 </v>
            <v>       0.39743590       0.00000000       0.39743590 </v>
            <v>       0.41025641       0.00000000       0.41025641 </v>
            <v>       0.42307692       0.00000000       0.42307692 </v>
            <v>       0.43589744       0.00000000       0.43589744 </v>
            <v>       0.44871795       0.00000000       0.44871795 </v>
            <v>       0.46153846       0.00000000       0.46153846 </v>
            <v>       0.47435897       0.00000000       0.47435897 </v>
            <v>       0.48717949       0.00000000       0.48717949 </v>
            <v>       0.50000000       0.00000000       0.50000000 </v>
            <v>       0.50000000       0.00000000       0.50000000 </v>
            <v>       0.50000000       0.00641026       0.50641026 </v>
            <v>       0.50000000       0.01282051       0.51282051 </v>
            <v>       0.50000000       0.01923077       0.51923077 </v>
            <v>       0.50000000       0.02564103       0.52564103 </v>
            <v>       0.50000000       0.03205128       0.53205128 </v>
            <v>       0.50000000       0.03846154       0.53846154 </v>
            <v>       0.50000000       0.04487179       0.54487179 </v>
            <v>       0.50000000       0.05128205       0.55128205 </v>
            <v>       0.50000000       0.05769231       0.55769231 </v>
            <v>       0.50000000       0.06410256       0.56410256 </v>
            <v>       0.50000000       0.07051282       0.57051282 </v>
            <v>       0.50000000       0.07692308       0.57692308 </v>
            <v>       0.50000000       0.08333333       0.58333333 </v>
            <v>       0.50000000       0.08974359       0.58974359 </v>
            <v>       0.50000000       0.09615385       0.59615385 </v>
            <v>       0.50000000       0.10256410       0.60256410 </v>
            <v>       0.50000000       0.10897436       0.60897436 </v>
            <v>       0.50000000       0.11538462       0.61538462 </v>
            <v>       0.50000000       0.12179487       0.62179487 </v>
            <v>       0.50000000       0.12820513       0.62820513 </v>
            <v>       0.50000000       0.13461538       0.63461538 </v>
            <v>       0.50000000       0.14102564       0.64102564 </v>
            <v>       0.50000000       0.14743590       0.64743590 </v>
            <v>       0.50000000       0.15384615       0.65384615 </v>
            <v>       0.50000000       0.16025641       0.66025641 </v>
            <v>       0.50000000       0.16666667       0.66666667 </v>
            <v>       0.50000000       0.17307692       0.67307692 </v>
            <v>       0.50000000       0.17948718       0.67948718 </v>
            <v>       0.50000000       0.18589744       0.68589744 </v>
            <v>       0.50000000       0.19230769       0.69230769 </v>
            <v>       0.50000000       0.19871795       0.69871795 </v>
            <v>       0.50000000       0.20512821       0.70512821 </v>
            <v>       0.50000000       0.21153846       0.71153846 </v>
            <v>       0.50000000       0.21794872       0.71794872 </v>
            <v>       0.50000000       0.22435897       0.72435897 </v>
            <v>       0.50000000       0.23076923       0.73076923 </v>
            <v>       0.50000000       0.23717949       0.73717949 </v>
            <v>       0.50000000       0.24358974       0.74358974 </v>
            <v>       0.50000000       0.25000000       0.75000000 </v>
            <v>       0.50000000       0.25000000       0.75000000 </v>
            <v>       0.49679487       0.25320513       0.75000000 </v>
            <v>       0.49358974       0.25641026       0.75000000 </v>
            <v>       0.49038462       0.25961538       0.75000000 </v>
            <v>       0.48717949       0.26282051       0.75000000 </v>
            <v>       0.48397436       0.26602564       0.75000000 </v>
            <v>       0.48076923       0.26923077       0.75000000 </v>
            <v>       0.47756410       0.27243590       0.75000000 </v>
            <v>       0.47435897       0.27564103       0.75000000 </v>
            <v>       0.47115385       0.27884615       0.75000000 </v>
            <v>       0.46794872       0.28205128       0.75000000 </v>
            <v>       0.46474359       0.28525641       0.75000000 </v>
            <v>       0.46153846       0.28846154       0.75000000 </v>
            <v>       0.45833333       0.29166667       0.75000000 </v>
            <v>       0.45512821       0.29487179       0.75000000 </v>
            <v>       0.45192308       0.29807692       0.75000000 </v>
            <v>       0.44871795       0.30128205       0.75000000 </v>
            <v>       0.44551282       0.30448718       0.75000000 </v>
            <v>       0.44230769       0.30769231       0.75000000 </v>
            <v>       0.43910256       0.31089744       0.75000000 </v>
            <v>       0.43589744       0.31410256       0.75000000 </v>
            <v>       0.43269231       0.31730769       0.75000000 </v>
            <v>       0.42948718       0.32051282       0.75000000 </v>
            <v>       0.42628205       0.32371795       0.75000000 </v>
            <v>       0.42307692       0.32692308       0.75000000 </v>
            <v>       0.41987179       0.33012821       0.75000000 </v>
            <v>       0.41666667       0.33333333       0.75000000 </v>
            <v>       0.41346154       0.33653846       0.75000000 </v>
            <v>       0.41025641       0.33974359       0.75000000 </v>
            <v>       0.40705128       0.34294872       0.75000000 </v>
            <v>       0.40384615       0.34615385       0.75000000 </v>
            <v>       0.40064103       0.34935897       0.75000000 </v>
            <v>       0.39743590       0.35256410       0.75000000 </v>
            <v>       0.39423077       0.35576923       0.75000000 </v>
            <v>       0.39102564       0.35897436       0.75000000 </v>
            <v>       0.38782051       0.36217949       0.75000000 </v>
            <v>       0.38461538       0.36538462       0.75000000 </v>
            <v>       0.38141026       0.36858974       0.75000000 </v>
            <v>       0.37820513       0.37179487       0.75000000 </v>
            <v>       0.37500000       0.37500000       0.75000000 </v>
            <v>       0.37500000       0.37500000       0.75000000 </v>
            <v>       0.36538462       0.36538462       0.73076923 </v>
            <v>       0.35576923       0.35576923       0.71153846 </v>
            <v>       0.34615385       0.34615385       0.69230769 </v>
            <v>       0.33653846       0.33653846       0.67307692 </v>
            <v>       0.32692308       0.32692308       0.65384615 </v>
            <v>       0.31730769       0.31730769       0.63461538 </v>
            <v>       0.30769231       0.30769231       0.61538462 </v>
            <v>       0.29807692       0.29807692       0.59615385 </v>
            <v>       0.28846154       0.28846154       0.57692308 </v>
            <v>       0.27884615       0.27884615       0.55769231 </v>
            <v>       0.26923077       0.26923077       0.53846154 </v>
            <v>       0.25961538       0.25961538       0.51923077 </v>
            <v>       0.25000000       0.25000000       0.50000000 </v>
            <v>       0.24038462       0.24038462       0.48076923 </v>
            <v>       0.23076923       0.23076923       0.46153846 </v>
            <v>       0.22115385       0.22115385       0.44230769 </v>
            <v>       0.21153846       0.21153846       0.42307692 </v>
            <v>       0.20192308       0.20192308       0.40384615 </v>
            <v>       0.19230769       0.19230769       0.38461538 </v>
            <v>       0.18269231       0.18269231       0.36538462 </v>
            <v>       0.17307692       0.17307692       0.34615385 </v>
            <v>       0.16346154       0.16346154       0.32692308 </v>
            <v>       0.15384615       0.15384615       0.30769231 </v>
            <v>       0.14423077       0.14423077       0.28846154 </v>
            <v>       0.13461538       0.13461538       0.26923077 </v>
            <v>       0.12500000       0.12500000       0.25000000 </v>
            <v>       0.11538462       0.11538462       0.23076923 </v>
            <v>       0.10576923       0.10576923       0.21153846 </v>
            <v>       0.09615385       0.09615385       0.19230769 </v>
            <v>       0.08653846       0.08653846       0.17307692 </v>
            <v>       0.07692308       0.07692308       0.15384615 </v>
            <v>       0.06730769       0.06730769       0.13461538 </v>
            <v>       0.05769231       0.05769231       0.11538462 </v>
            <v>       0.04807692       0.04807692       0.09615385 </v>
            <v>       0.03846154       0.03846154       0.07692308 </v>
            <v>       0.02884615       0.02884615       0.05769231 </v>
            <v>       0.01923077       0.01923077       0.03846154 </v>
            <v>       0.00961538       0.00961538       0.01923077 </v>
            <v>       0.00000000       0.00000000       0.00000000 </v>
            <v>       0.00000000       0.00000000       0.00000000 </v>
            <v>       0.01282051       0.01282051       0.01282051 </v>
            <v>       0.02564103       0.02564103       0.02564103 </v>
            <v>       0.03846154       0.03846154       0.03846154 </v>
            <v>       0.05128205       0.05128205       0.05128205 </v>
            <v>       0.06410256       0.06410256       0.06410256 </v>
            <v>       0.07692308       0.07692308       0.07692308 </v>
            <v>       0.08974359       0.08974359       0.08974359 </v>
            <v>       0.10256410       0.10256410       0.10256410 </v>
            <v>       0.11538462       0.11538462       0.11538462 </v>
            <v>       0.12820513       0.12820513       0.12820513 </v>
            <v>       0.14102564       0.14102564       0.14102564 </v>
            <v>       0.15384615       0.15384615       0.15384615 </v>
            <v>       0.16666667       0.16666667       0.16666667 </v>
            <v>       0.17948718       0.17948718       0.17948718 </v>
            <v>       0.19230769       0.19230769       0.19230769 </v>
            <v>       0.20512821       0.20512821       0.20512821 </v>
            <v>       0.21794872       0.21794872       0.21794872 </v>
            <v>       0.23076923       0.23076923       0.23076923 </v>
            <v>       0.24358974       0.24358974       0.24358974 </v>
            <v>       0.25641026       0.25641026       0.25641026 </v>
            <v>       0.26923077       0.26923077       0.26923077 </v>
            <v>       0.28205128       0.28205128       0.28205128 </v>
            <v>       0.29487179       0.29487179       0.29487179 </v>
            <v>       0.30769231       0.30769231       0.30769231 </v>
            <v>       0.32051282       0.32051282       0.32051282 </v>
            <v>       0.33333333       0.33333333       0.33333333 </v>
            <v>       0.34615385       0.34615385       0.34615385 </v>
            <v>       0.35897436       0.35897436       0.35897436 </v>
            <v>       0.37179487       0.37179487       0.37179487 </v>
            <v>       0.38461538       0.38461538       0.38461538 </v>
            <v>       0.39743590       0.39743590       0.39743590 </v>
            <v>       0.41025641       0.41025641       0.41025641 </v>
            <v>       0.42307692       0.42307692       0.42307692 </v>
            <v>       0.43589744       0.43589744       0.43589744 </v>
            <v>       0.44871795       0.44871795       0.44871795 </v>
            <v>       0.46153846       0.46153846       0.46153846 </v>
            <v>       0.47435897       0.47435897       0.47435897 </v>
            <v>       0.48717949       0.48717949       0.48717949 </v>
            <v>       0.50000000       0.50000000       0.50000000 </v>
            <v>       0.50000000       0.50000000       0.50000000 </v>
            <v>       0.50320513       0.49358974       0.50320513 </v>
            <v>       0.50641026       0.48717949       0.50641026 </v>
            <v>       0.50961538       0.48076923       0.50961538 </v>
            <v>       0.51282051       0.47435897       0.51282051 </v>
            <v>       0.51602564       0.46794872       0.51602564 </v>
            <v>       0.51923077       0.46153846       0.51923077 </v>
            <v>       0.52243590       0.45512821       0.52243590 </v>
            <v>       0.52564103       0.44871795       0.52564103 </v>
            <v>       0.52884615       0.44230769       0.52884615 </v>
            <v>       0.53205128       0.43589744       0.53205128 </v>
            <v>       0.53525641       0.42948718       0.53525641 </v>
            <v>       0.53846154       0.42307692       0.53846154 </v>
            <v>       0.54166667       0.41666667       0.54166667 </v>
            <v>       0.54487179       0.41025641       0.54487179 </v>
            <v>       0.54807692       0.40384615       0.54807692 </v>
            <v>       0.55128205       0.39743590       0.55128205 </v>
            <v>       0.55448718       0.39102564       0.55448718 </v>
            <v>       0.55769231       0.38461538       0.55769231 </v>
            <v>       0.56089744       0.37820513       0.56089744 </v>
            <v>       0.56410256       0.37179487       0.56410256 </v>
            <v>       0.56730769       0.36538462       0.56730769 </v>
            <v>       0.57051282       0.35897436       0.57051282 </v>
            <v>       0.57371795       0.35256410       0.57371795 </v>
            <v>       0.57692308       0.34615385       0.57692308 </v>
            <v>       0.58012821       0.33974359       0.58012821 </v>
            <v>       0.58333333       0.33333333       0.58333333 </v>
            <v>       0.58653846       0.32692308       0.58653846 </v>
            <v>       0.58974359       0.32051282       0.58974359 </v>
            <v>       0.59294872       0.31410256       0.59294872 </v>
            <v>       0.59615385       0.30769231       0.59615385 </v>
            <v>       0.59935897       0.30128205       0.59935897 </v>
            <v>       0.60256410       0.29487179       0.60256410 </v>
            <v>       0.60576923       0.28846154       0.60576923 </v>
            <v>       0.60897436       0.28205128       0.60897436 </v>
            <v>       0.61217949       0.27564103       0.61217949 </v>
            <v>       0.61538462       0.26923077       0.61538462 </v>
            <v>       0.61858974       0.26282051       0.61858974 </v>
            <v>       0.62179487       0.25641026       0.62179487 </v>
            <v>       0.62500000       0.25000000       0.62500000 </v>
            <v>       0.62500000       0.25000000       0.62500000 </v>
            <v>       0.62179487       0.25000000       0.62820513 </v>
            <v>       0.61858974       0.25000000       0.63141026 </v>
            <v>       0.61538462       0.25000000       0.63461538 </v>
            <v>       0.61217949       0.25000000       0.63782051 </v>
            <v>       0.60897436       0.25000000       0.64102564 </v>
            <v>       0.60576923       0.25000000       0.64423077 </v>
            <v>       0.60256410       0.25000000       0.64743590 </v>
            <v>       0.59935897       0.25000000       0.65064103 </v>
            <v>       0.59615385       0.25000000       0.65384615 </v>
            <v>       0.59294872       0.25000000       0.65705128 </v>
            <v>       0.58974359       0.25000000       0.66025641 </v>
            <v>       0.58653846       0.25000000       0.66346154 </v>
            <v>       0.58333333       0.25000000       0.66666667 </v>
            <v>       0.58012821       0.25000000       0.66987179 </v>
            <v>       0.57692308       0.25000000       0.67307692 </v>
            <v>       0.57371795       0.25000000       0.67628205 </v>
            <v>       0.57051282       0.25000000       0.67948718 </v>
            <v>       0.56730769       0.25000000       0.68269231 </v>
            <v>       0.56410256       0.25000000       0.68589744 </v>
            <v>       0.56089744       0.25000000       0.68910256 </v>
            <v>       0.55769231       0.25000000       0.69230769 </v>
            <v>       0.55448718       0.25000000       0.69551282 </v>
            <v>       0.55128205       0.25000000       0.69871795 </v>
            <v>       0.54807692       0.25000000       0.70192308 </v>
            <v>       0.54487179       0.25000000       0.70512821 </v>
            <v>       0.54166667       0.25000000       0.70833333 </v>
            <v>       0.53846154       0.25000000       0.71153846 </v>
            <v>       0.53525641       0.25000000       0.71474359 </v>
            <v>       0.53205128       0.25000000       0.71794872 </v>
            <v>       0.52884615       0.25000000       0.72115385 </v>
            <v>       0.52564103       0.25000000       0.72435897 </v>
            <v>       0.52243590       0.25000000       0.72756410 </v>
            <v>       0.51923077       0.25000000       0.73076923 </v>
            <v>       0.51602564       0.25000000       0.73397436 </v>
            <v>       0.51282051       0.25000000       0.73717949 </v>
            <v>       0.50961538       0.25000000       0.74038462 </v>
            <v>       0.50641026       0.25000000       0.74358974 </v>
            <v>       0.50320513       0.25000000       0.74679487 </v>
            <v>       0.50000000       0.25000000       0.75000000 </v>
            <v>       0.50000000       0.25000000       0.75000000 </v>
            <v>       0.50000000       0.25641026       0.74358974 </v>
            <v>       0.50000000       0.26282051       0.73717949 </v>
            <v>       0.50000000       0.26923077       0.73076923 </v>
            <v>       0.50000000       0.27564103       0.72435897 </v>
            <v>       0.50000000       0.28205128       0.71794872 </v>
            <v>       0.50000000       0.28846154       0.71153846 </v>
            <v>       0.50000000       0.29487179       0.70512821 </v>
            <v>       0.50000000       0.30128205       0.69871795 </v>
            <v>       0.50000000       0.30769231       0.69230769 </v>
            <v>       0.50000000       0.31410256       0.68589744 </v>
            <v>       0.50000000       0.32051282       0.67948718 </v>
            <v>       0.50000000       0.32692308       0.67307692 </v>
            <v>       0.50000000       0.33333333       0.66666667 </v>
            <v>       0.50000000       0.33974359       0.66025641 </v>
            <v>       0.50000000       0.34615385       0.65384615 </v>
            <v>       0.50000000       0.35256410       0.64743590 </v>
            <v>       0.50000000       0.35897436       0.64102564 </v>
            <v>       0.50000000       0.36538462       0.63461538 </v>
            <v>       0.50000000       0.37179487       0.62820513 </v>
            <v>       0.50000000       0.37820513       0.62179487 </v>
            <v>       0.50000000       0.38461538       0.61538462 </v>
            <v>       0.50000000       0.39102564       0.60897436 </v>
            <v>       0.50000000       0.39743590       0.60256410 </v>
            <v>       0.50000000       0.40384615       0.59615385 </v>
            <v>       0.50000000       0.41025641       0.58974359 </v>
            <v>       0.50000000       0.41666667       0.58333333 </v>
            <v>       0.50000000       0.42307692       0.57692308 </v>
            <v>       0.50000000       0.42948718       0.57051282 </v>
            <v>       0.50000000       0.43589744       0.56410256 </v>
            <v>       0.50000000       0.44230769       0.55769231 </v>
            <v>       0.50000000       0.44871795       0.55128205 </v>
            <v>       0.50000000       0.45512821       0.54487179 </v>
            <v>       0.50000000       0.46153846       0.53846154 </v>
            <v>       0.50000000       0.46794872       0.53205128 </v>
            <v>       0.50000000       0.47435897       0.52564103 </v>
            <v>       0.50000000       0.48076923       0.51923077 </v>
            <v>       0.50000000       0.48717949       0.51282051 </v>
            <v>       0.50000000       0.49358974       0.50641026 </v>
            <v>       0.50000000       0.50000000       0.50000000 </v>
            <v>       0.50000000       0.50000000       0.50000000 </v>
            <v>       0.49679487       0.49679487       0.50641026 </v>
            <v>       0.49358974       0.49358974       0.51282051 </v>
            <v>       0.49038462       0.49038462       0.51923077 </v>
            <v>       0.48717949       0.48717949       0.52564103 </v>
            <v>       0.48397436       0.48397436       0.53205128 </v>
            <v>       0.48076923       0.48076923       0.53846154 </v>
            <v>       0.47756410       0.47756410       0.54487179 </v>
            <v>       0.47435897       0.47435897       0.55128205 </v>
            <v>       0.47115385       0.47115385       0.55769231 </v>
            <v>       0.46794872       0.46794872       0.56410256 </v>
            <v>       0.46474359       0.46474359       0.57051282 </v>
            <v>       0.46153846       0.46153846       0.57692308 </v>
            <v>       0.45833333       0.45833333       0.58333333 </v>
            <v>       0.45512821       0.45512821       0.58974359 </v>
            <v>       0.45192308       0.45192308       0.59615385 </v>
            <v>       0.44871795       0.44871795       0.60256410 </v>
            <v>       0.44551282       0.44551282       0.60897436 </v>
            <v>       0.44230769       0.44230769       0.61538462 </v>
            <v>       0.43910256       0.43910256       0.62179487 </v>
            <v>       0.43589744       0.43589744       0.62820513 </v>
            <v>       0.43269231       0.43269231       0.63461538 </v>
            <v>       0.42948718       0.42948718       0.64102564 </v>
            <v>       0.42628205       0.42628205       0.64743590 </v>
            <v>       0.42307692       0.42307692       0.65384615 </v>
            <v>       0.41987179       0.41987179       0.66025641 </v>
            <v>       0.41666667       0.41666667       0.66666667 </v>
            <v>       0.41346154       0.41346154       0.67307692 </v>
            <v>       0.41025641       0.41025641       0.67948718 </v>
            <v>       0.40705128       0.40705128       0.68589744 </v>
            <v>       0.40384615       0.40384615       0.69230769 </v>
            <v>       0.40064103       0.40064103       0.69871795 </v>
            <v>       0.39743590       0.39743590       0.70512821 </v>
            <v>       0.39423077       0.39423077       0.71153846 </v>
            <v>       0.39102564       0.39102564       0.71794872 </v>
            <v>       0.38782051       0.38782051       0.72435897 </v>
            <v>       0.38461538       0.38461538       0.73076923 </v>
            <v>       0.38141026       0.38141026       0.73717949 </v>
            <v>       0.37820513       0.37820513       0.74358974 </v>
            <v>       0.37500000       0.37500000       0.75000000 </v>
            <v>       0.62500000       0.25000000       0.62500000 </v>
            <v>       0.62179487       0.24358974       0.62179487 </v>
            <v>       0.61858974       0.23717949       0.61858974 </v>
            <v>       0.61538462       0.23076923       0.61538462 </v>
            <v>       0.61217949       0.22435897       0.61217949 </v>
            <v>       0.60897436       0.21794872       0.60897436 </v>
            <v>       0.60576923       0.21153846       0.60576923 </v>
            <v>       0.60256410       0.20512821       0.60256410 </v>
            <v>       0.59935897       0.19871795       0.59935897 </v>
            <v>       0.59615385       0.19230769       0.59615385 </v>
            <v>       0.59294872       0.18589744       0.59294872 </v>
            <v>       0.58974359       0.17948718       0.58974359 </v>
            <v>       0.58653846       0.17307692       0.58653846 </v>
            <v>       0.58333333       0.16666667       0.58333333 </v>
            <v>       0.58012821       0.16025641       0.58012821 </v>
            <v>       0.57692308       0.15384615       0.57692308 </v>
            <v>       0.57371795       0.14743590       0.57371795 </v>
            <v>       0.57051282       0.14102564       0.57051282 </v>
            <v>       0.56730769       0.13461538       0.56730769 </v>
            <v>       0.56410256       0.12820513       0.56410256 </v>
            <v>       0.56089744       0.12179487       0.56089744 </v>
            <v>       0.55769231       0.11538462       0.55769231 </v>
            <v>       0.55448718       0.10897436       0.55448718 </v>
            <v>       0.55128205       0.10256410       0.55128205 </v>
            <v>       0.54807692       0.09615385       0.54807692 </v>
            <v>       0.54487179       0.08974359       0.54487179 </v>
            <v>       0.54166667       0.08333333       0.54166667 </v>
            <v>       0.53846154       0.07692308       0.53846154 </v>
            <v>       0.53525641       0.07051282       0.53525641 </v>
            <v>       0.53205128       0.06410256       0.53205128 </v>
            <v>       0.52884615       0.05769231       0.52884615 </v>
            <v>       0.52564103       0.05128205       0.52564103 </v>
            <v>       0.52243590       0.04487179       0.52243590 </v>
            <v>       0.51923077       0.03846154       0.51923077 </v>
            <v>       0.51602564       0.03205128       0.51602564 </v>
            <v>       0.51282051       0.02564103       0.51282051 </v>
            <v>       0.50961538       0.01923077       0.50961538 </v>
            <v>       0.50641026       0.01282051       0.50641026 </v>
            <v>       0.50320513       0.00641026       0.50320513 </v>
            <v>       0.50000000       0.00000000       0.50000000 </v>
        """
        # note that in the string above, the data lines start with '\n'
        # due to using the opening """ on its own line
        refkptstr = refkptstr.replace('\n', '')
        refkptstr = refkptstr.replace('<v>', '')
        refkptstr = refkptstr.replace('</v>', '\n')
        # the [:-1] necessary due to the last '\n' followed by the 
        # spaces that precede the closing """
        refkpts = [np.fromstring(line, sep=' ')
                   for line in refkptstr.split('\n')[:-1]]
        ref_data = {
            'SYSTEM': 'diamond_primitive_PBE',
            'ENMAX': 400.0,
            'ENAUG': 644.873,
            'EDIFF': 1.e-4,
            'NELECT': 8.0,
            'EREF': 0.0,
#            'ISMEAR': 0,
#            'ICHARG': 2,
#            'SIGMA': 0.1,
            'NBANDS': 12,

            'ISPIN': 1,
            'LSORBIT': False,
            'LNONCOLLINEAR': False,
            'SAXIS': [0, 0, 1.],
            'MAGMOM': [1., 1.],

#            'NSW': 0,
            'IBRION': -1,
            'ISIF': 2,
            'EDIFFG': 1.e-3,
            'GGA': '--',

            'efermi': 10.85000116,
            'e_fr_energy': -18.81670626,
            'e_wo_entrp': -18.81670626,
            'e_0_energy': -0.00000,

            'kmesh_type': 'listgenerated',
            'kmesh_division': 40,
            'kpoints': refkpts,
        }
        data = parse_vasprun('ref/unpolarised/bands-autokpts/vasprun.xml')
        for key, val in ref_data.items():
            try:
                self.assertEqual(val, data[key])
            except ValueError:
                self.assertEqual(np.asarray(val).shape, data[key].shape)
                nptest.assert_array_equal(np.asarray(val), data[key])

    def test_noncollinear_bands_explicitkpts(self):
        """Can we read xml from noncollinear bands calculation"""
        refkptstr = """
            <v>       0.50000000       0.50000000       0.50000000 </v>
            <v>       0.47619000       0.47619000       0.47619000 </v>
            <v>       0.45238100       0.45238100       0.45238100 </v>
            <v>       0.42857100       0.42857100       0.42857100 </v>
            <v>       0.40476200       0.40476200       0.40476200 </v>
            <v>       0.38095200       0.38095200       0.38095200 </v>
            <v>       0.35714300       0.35714300       0.35714300 </v>
            <v>       0.33333300       0.33333300       0.33333300 </v>
            <v>       0.30952400       0.30952400       0.30952400 </v>
            <v>       0.28571400       0.28571400       0.28571400 </v>
            <v>       0.26190500       0.26190500       0.26190500 </v>
            <v>       0.23809500       0.23809500       0.23809500 </v>
            <v>       0.21428600       0.21428600       0.21428600 </v>
            <v>       0.19047600       0.19047600       0.19047600 </v>
            <v>       0.16666700       0.16666700       0.16666700 </v>
            <v>       0.14285700       0.14285700       0.14285700 </v>
            <v>       0.11904800       0.11904800       0.11904800 </v>
            <v>       0.09523800       0.09523800       0.09523800 </v>
            <v>       0.07142900       0.07142900       0.07142900 </v>
            <v>       0.04761900       0.04761900       0.04761900 </v>
            <v>       0.02381000       0.02381000       0.02381000 </v>
            <v>       0.00000000       0.00000000       0.00000000 </v>
            <v>       0.02083300       0.00000000       0.02083300 </v>
            <v>       0.04166700       0.00000000       0.04166700 </v>
            <v>       0.06250000       0.00000000       0.06250000 </v>
            <v>       0.08333300       0.00000000       0.08333300 </v>
            <v>       0.10416700       0.00000000       0.10416700 </v>
            <v>       0.12500000       0.00000000       0.12500000 </v>
            <v>       0.14583300       0.00000000       0.14583300 </v>
            <v>       0.16666700       0.00000000       0.16666700 </v>
            <v>       0.18750000       0.00000000       0.18750000 </v>
            <v>       0.20833300       0.00000000       0.20833300 </v>
            <v>       0.22916700       0.00000000       0.22916700 </v>
            <v>       0.25000000       0.00000000       0.25000000 </v>
            <v>       0.27083300       0.00000000       0.27083300 </v>
            <v>       0.29166700       0.00000000       0.29166700 </v>
            <v>       0.31250000       0.00000000       0.31250000 </v>
            <v>       0.33333300       0.00000000       0.33333300 </v>
            <v>       0.35416700       0.00000000       0.35416700 </v>
            <v>       0.37500000       0.00000000       0.37500000 </v>
            <v>       0.39583300       0.00000000       0.39583300 </v>
            <v>       0.41666700       0.00000000       0.41666700 </v>
            <v>       0.43750000       0.00000000       0.43750000 </v>
            <v>       0.45833300       0.00000000       0.45833300 </v>
            <v>       0.47916700       0.00000000       0.47916700 </v>
            <v>       0.50000000       0.00000000       0.50000000 </v>
            <v>       0.51562500       0.03125000       0.51562500 </v>
            <v>       0.53125000       0.06250000       0.53125000 </v>
            <v>       0.54687500       0.09375000       0.54687500 </v>
            <v>       0.56250000       0.12500000       0.56250000 </v>
            <v>       0.57812500       0.15625000       0.57812500 </v>
            <v>       0.59375000       0.18750000       0.59375000 </v>
            <v>       0.60937500       0.21875000       0.60937500 </v>
            <v>       0.62500000       0.25000000       0.62500000 </v>
            <v>       0.37500000       0.37500000       0.75000000 </v>
            <v>       0.36111100       0.36111100       0.72222200 </v>
            <v>       0.34722200       0.34722200       0.69444400 </v>
            <v>       0.33333300       0.33333300       0.66666700 </v>
            <v>       0.31944400       0.31944400       0.63888900 </v>
            <v>       0.30555600       0.30555600       0.61111100 </v>
            <v>       0.29166700       0.29166700       0.58333300 </v>
            <v>       0.27777800       0.27777800       0.55555600 </v>
            <v>       0.26388900       0.26388900       0.52777800 </v>
            <v>       0.25000000       0.25000000       0.50000000 </v>
            <v>       0.23611100       0.23611100       0.47222200 </v>
            <v>       0.22222200       0.22222200       0.44444400 </v>
            <v>       0.20833300       0.20833300       0.41666700 </v>
            <v>       0.19444400       0.19444400       0.38888900 </v>
            <v>       0.18055600       0.18055600       0.36111100 </v>
            <v>       0.16666700       0.16666700       0.33333300 </v>
            <v>       0.15277800       0.15277800       0.30555600 </v>
            <v>       0.13888900       0.13888900       0.27777800 </v>
            <v>       0.12500000       0.12500000       0.25000000 </v>
            <v>       0.11111100       0.11111100       0.22222200 </v>
            <v>       0.09722200       0.09722200       0.19444400 </v>
            <v>       0.08333300       0.08333300       0.16666700 </v>
            <v>       0.06944400       0.06944400       0.13888900 </v>
            <v>       0.05555600       0.05555600       0.11111100 </v>
            <v>       0.04166700       0.04166700       0.08333300 </v>
            <v>       0.02777800       0.02777800       0.05555600 </v>
            <v>       0.01388900       0.01388900       0.02777800 </v>
            <v>       0.00000000       0.00000000       0.00000000 </v>
        """
        # note that in the string above, the data lines start with '\n'
        # due to using the opening """ on its own line
        refkptstr = refkptstr.replace('\n', '')
        refkptstr = refkptstr.replace('<v>', '')
        refkptstr = refkptstr.replace('</v>', '\n')
        # the [:-1] necessary due to the last '\n' followed by the 
        # spaces that precede the closing """
        refkpts = [np.fromstring(line, sep=' ')
                   for line in refkptstr.split('\n')[:-1]]
        ref_data = {
            'SYSTEM': 'Germanium Diamond w/ SOC',
            'ENMAX': 320.0,
            'ENAUG': 640.0,
            'EDIFF': 1.e-5,
            'NELECT': 8.0,
            'EREF': 0.0,
#            'ISMEAR': 0,
#            'ICHARG': 2,
#            'SIGMA': 0.1,
            'NBANDS': 24,

            'ISPIN': 1,
            'LSORBIT': True,
            'LNONCOLLINEAR': True,
            'SAXIS': [0, 0, 1.],
            'MAGMOM': [0, 0, 0, 0, 0, 0],

#            'NSW': 0,
            'IBRION': -1,
            'ISIF': 2,
            'EDIFFG': 1.e-4,
            'GGA': 'PS',

            'efermi': 3.51490051,
            'e_fr_energy': -4.32669915,
            'e_wo_entrp': -4.32152507,
            'e_0_energy': -0.01034816,

            'kmesh_type': None,
            'kmesh_division': None,
            'kpoints': refkpts,
        }
        data = parse_vasprun('ref/noncollinear/bands/vasprun.xml')
        for key, val in ref_data.items():
            try:
                self.assertEqual(val, data[key])
            except ValueError:
                self.assertEqual(np.asarray(val).shape, data[key].shape)
                nptest.assert_array_equal(np.asarray(val), data[key])


if __name__ == '__main__':
    unittest.main()
