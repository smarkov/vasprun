"""Test vasprun.xml reader"""
import unittest
import numpy as np
import numpy.testing as nptest
from pprint import pprint
from vasprun.io import parse_vasprun

class XMLReadTest(unittest.TestCase):
    """
    Test XML reader
    """
    def test_unpolarised_scf(self):
        """Can we read xml from unpolarised SCF calculation"""
        refkptstr = """
            <v>       0.00000000       0.00000000       0.00000000 </v>
            <v>       0.04761905       0.00000000       0.00000000 </v>
            <v>       0.09523810       0.00000000       0.00000000 </v>
            <v>       0.14285714       0.00000000       0.00000000 </v>
            <v>       0.19047619       0.00000000       0.00000000 </v>
            <v>       0.23809524       0.00000000       0.00000000 </v>
            <v>       0.28571429       0.00000000       0.00000000 </v>
            <v>       0.33333333       0.00000000       0.00000000 </v>
            <v>       0.38095238       0.00000000       0.00000000 </v>
            <v>       0.42857143       0.00000000       0.00000000 </v>
            <v>       0.47619048       0.00000000       0.00000000 </v>
            <v>       0.04761905       0.04761905       0.00000000 </v>
            <v>       0.09523810       0.04761905       0.00000000 </v>
            <v>       0.14285714       0.04761905       0.00000000 </v>
            <v>       0.19047619       0.04761905       0.00000000 </v>
            <v>       0.23809524       0.04761905       0.00000000 </v>
            <v>       0.28571429       0.04761905       0.00000000 </v>
            <v>       0.33333333       0.04761905       0.00000000 </v>
            <v>       0.38095238       0.04761905       0.00000000 </v>
            <v>       0.42857143       0.04761905       0.00000000 </v>
            <v>       0.47619048       0.04761905       0.00000000 </v>
            <v>      -0.47619048       0.04761905       0.00000000 </v>
            <v>      -0.42857143       0.04761905       0.00000000 </v>
            <v>      -0.38095238       0.04761905       0.00000000 </v>
            <v>      -0.33333333       0.04761905       0.00000000 </v>
            <v>      -0.28571429       0.04761905       0.00000000 </v>
            <v>      -0.23809524       0.04761905       0.00000000 </v>
            <v>      -0.19047619       0.04761905       0.00000000 </v>
            <v>      -0.14285714       0.04761905       0.00000000 </v>
            <v>      -0.09523810       0.04761905       0.00000000 </v>
            <v>      -0.04761905       0.04761905       0.00000000 </v>
            <v>       0.09523810       0.09523810       0.00000000 </v>
            <v>       0.14285714       0.09523810       0.00000000 </v>
            <v>       0.19047619       0.09523810       0.00000000 </v>
            <v>       0.23809524       0.09523810       0.00000000 </v>
            <v>       0.28571429       0.09523810       0.00000000 </v>
            <v>       0.33333333       0.09523810       0.00000000 </v>
            <v>       0.38095238       0.09523810       0.00000000 </v>
            <v>       0.42857143       0.09523810       0.00000000 </v>
            <v>       0.47619048       0.09523810       0.00000000 </v>
            <v>      -0.47619048       0.09523810       0.00000000 </v>
            <v>      -0.42857143       0.09523810       0.00000000 </v>
            <v>      -0.38095238       0.09523810       0.00000000 </v>
            <v>      -0.33333333       0.09523810       0.00000000 </v>
            <v>      -0.28571429       0.09523810       0.00000000 </v>
            <v>      -0.23809524       0.09523810       0.00000000 </v>
            <v>      -0.19047619       0.09523810       0.00000000 </v>
            <v>      -0.14285714       0.09523810       0.00000000 </v>
            <v>      -0.09523810       0.09523810       0.00000000 </v>
            <v>       0.14285714       0.14285714       0.00000000 </v>
            <v>       0.19047619       0.14285714       0.00000000 </v>
            <v>       0.23809524       0.14285714       0.00000000 </v>
            <v>       0.28571429       0.14285714       0.00000000 </v>
            <v>       0.33333333       0.14285714       0.00000000 </v>
            <v>       0.38095238       0.14285714       0.00000000 </v>
            <v>       0.42857143       0.14285714       0.00000000 </v>
            <v>       0.47619048       0.14285714       0.00000000 </v>
            <v>      -0.47619048       0.14285714       0.00000000 </v>
            <v>      -0.42857143       0.14285714       0.00000000 </v>
            <v>      -0.38095238       0.14285714       0.00000000 </v>
            <v>      -0.33333333       0.14285714       0.00000000 </v>
            <v>      -0.28571429       0.14285714       0.00000000 </v>
            <v>      -0.23809524       0.14285714       0.00000000 </v>
            <v>      -0.19047619       0.14285714       0.00000000 </v>
            <v>      -0.14285714       0.14285714       0.00000000 </v>
            <v>       0.19047619       0.19047619       0.00000000 </v>
            <v>       0.23809524       0.19047619       0.00000000 </v>
            <v>       0.28571429       0.19047619       0.00000000 </v>
            <v>       0.33333333       0.19047619       0.00000000 </v>
            <v>       0.38095238       0.19047619       0.00000000 </v>
            <v>       0.42857143       0.19047619       0.00000000 </v>
            <v>       0.47619048       0.19047619       0.00000000 </v>
            <v>      -0.47619048       0.19047619       0.00000000 </v>
            <v>      -0.42857143       0.19047619       0.00000000 </v>
            <v>      -0.38095238       0.19047619       0.00000000 </v>
            <v>      -0.33333333       0.19047619       0.00000000 </v>
            <v>      -0.28571429       0.19047619       0.00000000 </v>
            <v>      -0.23809524       0.19047619       0.00000000 </v>
            <v>      -0.19047619       0.19047619       0.00000000 </v>
            <v>       0.23809524       0.23809524       0.00000000 </v>
            <v>       0.28571429       0.23809524       0.00000000 </v>
            <v>       0.33333333       0.23809524       0.00000000 </v>
            <v>       0.38095238       0.23809524       0.00000000 </v>
            <v>       0.42857143       0.23809524       0.00000000 </v>
            <v>       0.47619048       0.23809524       0.00000000 </v>
            <v>      -0.47619048       0.23809524       0.00000000 </v>
            <v>      -0.42857143       0.23809524       0.00000000 </v>
            <v>      -0.38095238       0.23809524       0.00000000 </v>
            <v>      -0.33333333       0.23809524       0.00000000 </v>
            <v>      -0.28571429       0.23809524       0.00000000 </v>
            <v>      -0.23809524       0.23809524       0.00000000 </v>
            <v>       0.28571429       0.28571429       0.00000000 </v>
            <v>       0.33333333       0.28571429       0.00000000 </v>
            <v>       0.38095238       0.28571429       0.00000000 </v>
            <v>       0.42857143       0.28571429       0.00000000 </v>
            <v>       0.47619048       0.28571429       0.00000000 </v>
            <v>      -0.47619048       0.28571429       0.00000000 </v>
            <v>      -0.42857143       0.28571429       0.00000000 </v>
            <v>      -0.38095238       0.28571429       0.00000000 </v>
            <v>      -0.33333333       0.28571429       0.00000000 </v>
            <v>      -0.28571429       0.28571429       0.00000000 </v>
            <v>       0.33333333       0.33333333       0.00000000 </v>
            <v>       0.38095238       0.33333333       0.00000000 </v>
            <v>       0.42857143       0.33333333       0.00000000 </v>
            <v>       0.47619048       0.33333333       0.00000000 </v>
            <v>      -0.47619048       0.33333333       0.00000000 </v>
            <v>      -0.42857143       0.33333333       0.00000000 </v>
            <v>      -0.38095238       0.33333333       0.00000000 </v>
            <v>      -0.33333333       0.33333333       0.00000000 </v>
            <v>       0.38095238       0.38095238       0.00000000 </v>
            <v>       0.42857143       0.38095238       0.00000000 </v>
            <v>       0.47619048       0.38095238       0.00000000 </v>
            <v>      -0.47619048       0.38095238       0.00000000 </v>
            <v>      -0.42857143       0.38095238       0.00000000 </v>
            <v>      -0.38095238       0.38095238       0.00000000 </v>
            <v>       0.42857143       0.42857143       0.00000000 </v>
            <v>       0.47619048       0.42857143       0.00000000 </v>
            <v>      -0.47619048       0.42857143       0.00000000 </v>
            <v>      -0.42857143       0.42857143       0.00000000 </v>
            <v>       0.47619048       0.47619048       0.00000000 </v>
            <v>      -0.47619048       0.47619048       0.00000000 </v>
            <v>       0.14285714       0.09523810       0.04761905 </v>
            <v>       0.19047619       0.09523810       0.04761905 </v>
            <v>       0.23809524       0.09523810       0.04761905 </v>
            <v>       0.28571429       0.09523810       0.04761905 </v>
            <v>       0.33333333       0.09523810       0.04761905 </v>
            <v>       0.38095238       0.09523810       0.04761905 </v>
            <v>       0.42857143       0.09523810       0.04761905 </v>
            <v>       0.47619048       0.09523810       0.04761905 </v>
            <v>      -0.47619048       0.09523810       0.04761905 </v>
            <v>       0.19047619       0.14285714       0.04761905 </v>
            <v>       0.23809524       0.14285714       0.04761905 </v>
            <v>       0.28571429       0.14285714       0.04761905 </v>
            <v>       0.33333333       0.14285714       0.04761905 </v>
            <v>       0.38095238       0.14285714       0.04761905 </v>
            <v>       0.42857143       0.14285714       0.04761905 </v>
            <v>       0.47619048       0.14285714       0.04761905 </v>
            <v>      -0.47619048       0.14285714       0.04761905 </v>
            <v>      -0.42857143       0.14285714       0.04761905 </v>
            <v>      -0.38095238       0.14285714       0.04761905 </v>
            <v>      -0.33333333       0.14285714       0.04761905 </v>
            <v>      -0.28571429       0.14285714       0.04761905 </v>
            <v>      -0.23809524       0.14285714       0.04761905 </v>
            <v>      -0.19047619       0.14285714       0.04761905 </v>
            <v>      -0.14285714       0.14285714       0.04761905 </v>
            <v>      -0.09523810       0.14285714       0.04761905 </v>
            <v>       0.23809524       0.19047619       0.04761905 </v>
            <v>       0.28571429       0.19047619       0.04761905 </v>
            <v>       0.33333333       0.19047619       0.04761905 </v>
            <v>       0.38095238       0.19047619       0.04761905 </v>
            <v>       0.42857143       0.19047619       0.04761905 </v>
            <v>       0.47619048       0.19047619       0.04761905 </v>
            <v>      -0.47619048       0.19047619       0.04761905 </v>
            <v>      -0.42857143       0.19047619       0.04761905 </v>
            <v>      -0.38095238       0.19047619       0.04761905 </v>
            <v>      -0.33333333       0.19047619       0.04761905 </v>
            <v>      -0.28571429       0.19047619       0.04761905 </v>
            <v>      -0.23809524       0.19047619       0.04761905 </v>
            <v>      -0.19047619       0.19047619       0.04761905 </v>
            <v>      -0.14285714       0.19047619       0.04761905 </v>
            <v>       0.28571429       0.23809524       0.04761905 </v>
            <v>       0.33333333       0.23809524       0.04761905 </v>
            <v>       0.38095238       0.23809524       0.04761905 </v>
            <v>       0.42857143       0.23809524       0.04761905 </v>
            <v>       0.47619048       0.23809524       0.04761905 </v>
            <v>      -0.47619048       0.23809524       0.04761905 </v>
            <v>      -0.42857143       0.23809524       0.04761905 </v>
            <v>      -0.38095238       0.23809524       0.04761905 </v>
            <v>      -0.33333333       0.23809524       0.04761905 </v>
            <v>      -0.28571429       0.23809524       0.04761905 </v>
            <v>      -0.23809524       0.23809524       0.04761905 </v>
            <v>      -0.19047619       0.23809524       0.04761905 </v>
            <v>       0.33333333       0.28571429       0.04761905 </v>
            <v>       0.38095238       0.28571429       0.04761905 </v>
            <v>       0.42857143       0.28571429       0.04761905 </v>
            <v>       0.47619048       0.28571429       0.04761905 </v>
            <v>      -0.47619048       0.28571429       0.04761905 </v>
            <v>      -0.42857143       0.28571429       0.04761905 </v>
            <v>      -0.38095238       0.28571429       0.04761905 </v>
            <v>      -0.33333333       0.28571429       0.04761905 </v>
            <v>      -0.28571429       0.28571429       0.04761905 </v>
            <v>      -0.23809524       0.28571429       0.04761905 </v>
            <v>       0.38095238       0.33333333       0.04761905 </v>
            <v>       0.42857143       0.33333333       0.04761905 </v>
            <v>       0.47619048       0.33333333       0.04761905 </v>
            <v>      -0.47619048       0.33333333       0.04761905 </v>
            <v>      -0.42857143       0.33333333       0.04761905 </v>
            <v>      -0.38095238       0.33333333       0.04761905 </v>
            <v>      -0.33333333       0.33333333       0.04761905 </v>
            <v>      -0.28571429       0.33333333       0.04761905 </v>
            <v>       0.42857143       0.38095238       0.04761905 </v>
            <v>       0.47619048       0.38095238       0.04761905 </v>
            <v>      -0.47619048       0.38095238       0.04761905 </v>
            <v>      -0.42857143       0.38095238       0.04761905 </v>
            <v>      -0.38095238       0.38095238       0.04761905 </v>
            <v>      -0.33333333       0.38095238       0.04761905 </v>
            <v>       0.47619048       0.42857143       0.04761905 </v>
            <v>      -0.47619048       0.42857143       0.04761905 </v>
            <v>      -0.42857143       0.42857143       0.04761905 </v>
            <v>      -0.38095238       0.42857143       0.04761905 </v>
            <v>      -0.47619048       0.47619048       0.04761905 </v>
            <v>      -0.42857143       0.47619048       0.04761905 </v>
            <v>       0.28571429       0.19047619       0.09523810 </v>
            <v>       0.33333333       0.19047619       0.09523810 </v>
            <v>       0.38095238       0.19047619       0.09523810 </v>
            <v>       0.42857143       0.19047619       0.09523810 </v>
            <v>       0.47619048       0.19047619       0.09523810 </v>
            <v>      -0.47619048       0.19047619       0.09523810 </v>
            <v>      -0.42857143       0.19047619       0.09523810 </v>
            <v>       0.33333333       0.23809524       0.09523810 </v>
            <v>       0.38095238       0.23809524       0.09523810 </v>
            <v>       0.42857143       0.23809524       0.09523810 </v>
            <v>       0.47619048       0.23809524       0.09523810 </v>
            <v>      -0.47619048       0.23809524       0.09523810 </v>
            <v>      -0.42857143       0.23809524       0.09523810 </v>
            <v>      -0.38095238       0.23809524       0.09523810 </v>
            <v>      -0.33333333       0.23809524       0.09523810 </v>
            <v>      -0.28571429       0.23809524       0.09523810 </v>
            <v>      -0.23809524       0.23809524       0.09523810 </v>
            <v>      -0.19047619       0.23809524       0.09523810 </v>
            <v>      -0.14285714       0.23809524       0.09523810 </v>
            <v>       0.38095238       0.28571429       0.09523810 </v>
            <v>       0.42857143       0.28571429       0.09523810 </v>
            <v>       0.47619048       0.28571429       0.09523810 </v>
            <v>      -0.47619048       0.28571429       0.09523810 </v>
            <v>      -0.42857143       0.28571429       0.09523810 </v>
            <v>      -0.38095238       0.28571429       0.09523810 </v>
            <v>      -0.33333333       0.28571429       0.09523810 </v>
            <v>      -0.28571429       0.28571429       0.09523810 </v>
            <v>      -0.23809524       0.28571429       0.09523810 </v>
            <v>      -0.19047619       0.28571429       0.09523810 </v>
            <v>       0.42857143       0.33333333       0.09523810 </v>
            <v>       0.47619048       0.33333333       0.09523810 </v>
            <v>      -0.47619048       0.33333333       0.09523810 </v>
            <v>      -0.42857143       0.33333333       0.09523810 </v>
            <v>      -0.38095238       0.33333333       0.09523810 </v>
            <v>      -0.33333333       0.33333333       0.09523810 </v>
            <v>      -0.28571429       0.33333333       0.09523810 </v>
            <v>      -0.23809524       0.33333333       0.09523810 </v>
            <v>       0.47619048       0.38095238       0.09523810 </v>
            <v>      -0.47619048       0.38095238       0.09523810 </v>
            <v>      -0.42857143       0.38095238       0.09523810 </v>
            <v>      -0.38095238       0.38095238       0.09523810 </v>
            <v>      -0.33333333       0.38095238       0.09523810 </v>
            <v>      -0.28571429       0.38095238       0.09523810 </v>
            <v>      -0.47619048       0.42857143       0.09523810 </v>
            <v>      -0.42857143       0.42857143       0.09523810 </v>
            <v>      -0.38095238       0.42857143       0.09523810 </v>
            <v>      -0.33333333       0.42857143       0.09523810 </v>
            <v>      -0.42857143       0.47619048       0.09523810 </v>
            <v>      -0.38095238       0.47619048       0.09523810 </v>
            <v>       0.42857143       0.28571429       0.14285714 </v>
            <v>       0.47619048       0.28571429       0.14285714 </v>
            <v>      -0.47619048       0.28571429       0.14285714 </v>
            <v>      -0.42857143       0.28571429       0.14285714 </v>
            <v>      -0.38095238       0.28571429       0.14285714 </v>
            <v>       0.47619048       0.33333333       0.14285714 </v>
            <v>      -0.47619048       0.33333333       0.14285714 </v>
            <v>      -0.42857143       0.33333333       0.14285714 </v>
            <v>      -0.38095238       0.33333333       0.14285714 </v>
            <v>      -0.33333333       0.33333333       0.14285714 </v>
            <v>      -0.28571429       0.33333333       0.14285714 </v>
            <v>      -0.23809524       0.33333333       0.14285714 </v>
            <v>      -0.19047619       0.33333333       0.14285714 </v>
            <v>      -0.47619048       0.38095238       0.14285714 </v>
            <v>      -0.42857143       0.38095238       0.14285714 </v>
            <v>      -0.38095238       0.38095238       0.14285714 </v>
            <v>      -0.33333333       0.38095238       0.14285714 </v>
            <v>      -0.28571429       0.38095238       0.14285714 </v>
            <v>      -0.23809524       0.38095238       0.14285714 </v>
            <v>      -0.42857143       0.42857143       0.14285714 </v>
            <v>      -0.38095238       0.42857143       0.14285714 </v>
            <v>      -0.33333333       0.42857143       0.14285714 </v>
            <v>      -0.28571429       0.42857143       0.14285714 </v>
            <v>      -0.38095238       0.47619048       0.14285714 </v>
            <v>      -0.33333333       0.47619048       0.14285714 </v>
            <v>      -0.42857143       0.38095238       0.19047619 </v>
            <v>      -0.38095238       0.38095238       0.19047619 </v>
            <v>      -0.33333333       0.38095238       0.19047619 </v>
            <v>      -0.38095238       0.42857143       0.19047619 </v>
            <v>      -0.33333333       0.42857143       0.19047619 </v>
            <v>      -0.28571429       0.42857143       0.19047619 </v>
            <v>      -0.23809524       0.42857143       0.19047619 </v>
            <v>      -0.33333333       0.47619048       0.19047619 </v>
            <v>      -0.28571429       0.47619048       0.19047619 </v>
            <v>      -0.28571429       0.47619048       0.23809524 </v>
        """
        # note that in the string above, the data lines start with '\n'
        # due to using the opening """ on its own line
        refkptstr = refkptstr.replace('\n', '')
        refkptstr = refkptstr.replace('<v>', '')
        refkptstr = refkptstr.replace('</v>', '\n')
        # the [:-1] necessary due to the last '\n' followed by the 
        # spaces that precede the closing """
        refkpts = [np.fromstring(line, sep=' ')
                   for line in refkptstr.split('\n')[:-1]]
        ref_data = {
            'SYSTEM': 'Si0.5Ge0.5 zincblende primitive PBESol',
            'ENMAX': 320.0,
            'ENAUG': 640.0,
            'EDIFF': 0.1e-4,
            'NELECT': 8.0,
            'EREF': 0.0,
#            'ISMEAR': 0,
#            'ICHARG': 2,
#            'SIGMA': 0.1,
            'NBANDS': 24,

            'ISPIN': 1,
            'LSORBIT': False,
            'LNONCOLLINEAR': False,
            'SAXIS': [0, 0, 1.],
            'MAGMOM': [1., 1.],

#            'NSW': 0,
            'IBRION': -1,
            'ISIF': 2,
            'EDIFFG': 0.1e-3,
            'GGA': 'PS',

            'efermi': 5.06299199,
            'e_fr_energy': -10.57676490,
            'e_wo_entrp': -10.57676434,
            'e_0_energy': -0.00000112,

            'kmesh_type': 'Monkhorst-Pack',
            'kmesh_division': [21, 21, 21],
            'kpoints': refkpts,
        }
        data = parse_vasprun('ref/unpolarised/scf/vasprun.xml')
        for key, val in ref_data.items():
            try:
                self.assertEqual(val, data[key])
            except ValueError:
                self.assertEqual(np.asarray(val).shape, data[key].shape)
                nptest.assert_array_equal(np.asarray(val), data[key])


if __name__ == '__main__':
    unittest.main()
